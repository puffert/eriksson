name: Convert Issue to Blog Post

on:
  issues:
    types: [opened, labeled, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string

jobs:
  create-blog-post:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Parse issue and create blog post
        uses: actions/github-script@v7
        with:
          script: |
            // Get issue number - either from workflow_dispatch input or from event
            let issueNumber;
            if (context.eventName === 'workflow_dispatch') {
              issueNumber = parseInt(context.payload.inputs.issue_number);
            } else {
              issueNumber = context.payload.issue.number;
            }
            
            // Fetch the issue to ensure we have the latest data
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });
            
            const body = issue.body || '';
            const labels = issue.labels || [];
            const labelNames = labels.map(l => l.name || l);
            
            // Check if this is a blog post issue
            // Either has the label, or has the required fields from the template
            const hasBlogLabel = labelNames.some(name => 
              name === 'publish' || name === 'blog-post'
            );
            
            // Parse the issue body (GitHub form format)
            // GitHub Forms format: ### Field Name\n\n[value]\n\n
            const parseField = (fieldName) => {
              // Try multiple patterns to handle different formats
              const patterns = [
                new RegExp(`### ${fieldName}\\s*\\n\\n([^#]+?)(?=\\n\\n###|$)`, 'is'),
                new RegExp(`### ${fieldName}\\s*\\n\\n([^#]+)`, 'i'),
                new RegExp(`\\*\\*${fieldName}\\*\\*:?\\s*\\n\\n([^#]+?)(?=\\n\\n\\*\\*|$)`, 'is'),
              ];
              
              for (const regex of patterns) {
                const match = body.match(regex);
                if (match && match[1]) {
                  return match[1].trim();
                }
              }
              return '';
            };
            
            const title = parseField('Post Title');
            const description = parseField('Description');
            const category = parseField('Category');
            const tagsStr = parseField('Tags') || '';
            const tags = tagsStr.split(',').map(t => t.trim()).filter(Boolean);
            const icon = parseField('Icon \\(optional\\)') || parseField('Icon') || 'üìÑ';
            const content = parseField('Content');
            const source = parseField('Source URL \\(optional\\)') || parseField('Source URL') || '';
            
            // Check if this looks like a blog post (has required fields)
            const isBlogPost = title && description && category && content;
            
            // Log what we found for debugging
            console.log('Issue analysis:', {
              issueNumber: issue.number,
              hasBlogLabel,
              isBlogPost,
              title: title || 'MISSING',
              description: description ? 'Present' : 'MISSING',
              category: category || 'MISSING',
              content: content ? 'Present' : 'MISSING'
            });
            
            // If not a blog post and no label, add comment explaining why
            if (!hasBlogLabel && !isBlogPost) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚ÑπÔ∏è This issue doesn't appear to be a blog post yet.\n\n**Missing fields:**\n${!title ? '- ‚ùå Post Title\n' : ''}${!description ? '- ‚ùå Description\n' : ''}${!category ? '- ‚ùå Category\n' : ''}${!content ? '- ‚ùå Content\n' : ''}\n\n**To publish this as a blog post:**\n1. Use the "üìù New Blog Post" template, or\n2. Add the required fields manually, or\n3. Add the "publish" label to trigger processing\n\nOnce all fields are present, the workflow will automatically process it.`
              });
              return;
            }
            
            // If it's a blog post but no label, add the publish label
            if (isBlogPost && !hasBlogLabel) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['publish']
                });
              } catch (error) {
                console.log('Could not add label (might not exist):', error.message);
              }
            }
            
            // Validate required fields
            if (!title || !description || !category || !content) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚ùå Error: Missing required fields.\n\nParsed values:\n- Title: ${title || 'MISSING'}\n- Description: ${description || 'MISSING'}\n- Category: ${category || 'MISSING'}\n- Content: ${content ? 'Present' : 'MISSING'}\n\nPlease check the issue format and try again.`
              });
              return;
            }
            
            // Generate slug from title
            const slug = title.toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '');
            
            if (!slug) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚ùå Error: Could not generate a valid slug from the title. Please check the title format.`
              });
              return;
            }
            
            // Determine header image based on category
            const headerImages = {
              'Offensive Security': 'offensive',
              'Learning': 'AITesting',
              'News': 'news'
            };
            const headerImage = headerImages[category] || 'AITesting';
            
            // Create blog post content
            const date = new Date().toISOString().split('T')[0];
            
            // Escape YAML strings properly
            const escapeYaml = (str) => {
              if (!str) return '';
              // Replace newlines with spaces for single-line YAML fields
              return str.replace(/\n/g, ' ').replace(/"/g, '\\"').replace(/\\/g, '\\\\').trim();
            };
            
            // Format date properly for YAML (YYYY-MM-DD format)
            const frontmatter = `---
title: "${escapeYaml(title)}"
description: "${escapeYaml(description)}"
pubDate: ${date}
category: "${escapeYaml(category)}"
icon: "${escapeYaml(icon)}"
tags: [${tags.length > 0 ? tags.map(t => `"${escapeYaml(t)}"`).join(', ') : ''}]
image: "${headerImage}.png"
draft: false
---

`;
            
            const fullContent = frontmatter + content + 
              (source ? `\n\n---\n\n[Original Source](${source})` : '');
            
            // Create the file
            const filePath = `src/content/blog/${slug}.md`;
            
            // Check if file already exists
            try {
              await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: filePath,
              });
              
              // File exists, add comment and close issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚ùå A blog post with this title already exists. Please choose a different title.`
              });
              return;
            } catch (error) {
              // File doesn't exist, proceed
            }
            
            // Get the default branch
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            // Create the blog post file
            try {
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: filePath,
                message: `üìù New blog post: ${title}`,
                content: Buffer.from(fullContent).toString('base64'),
                branch: repo.default_branch,
              });
              
              // Add comment to issue with details
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚úÖ Blog post created successfully!\n\n**File created:** \`${filePath}\`\n**Slug:** \`${slug}\`\n**Category:** ${category}\n**Header Image:** ${headerImage}.png\n\nView it at: https://vortexnode.net/blog/${slug}\n\nThe post will be live after the deployment workflow completes (usually within 2-3 minutes). Check the [Actions tab](https://github.com/${context.repo.owner}/${context.repo.repo}/actions) to see deployment status.`
              });
              
              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚ùå Error creating blog post: ${error.message}\n\nPlease check the GitHub Actions logs for more details.`
              });
              throw error;
            }
