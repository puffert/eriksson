name: Convert Issue to Blog Post

on:
  issues:
    types: [labeled]

jobs:
  create-blog-post:
    if: contains(github.event.label.name, 'publish')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Parse issue and create blog post
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            
            // Parse the issue body (GitHub form format)
            const parseField = (fieldName) => {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\n([^#]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const title = parseField('Post Title');
            const description = parseField('Description');
            const category = parseField('Category');
            const tags = parseField('Tags').split(',').map(t => t.trim()).filter(Boolean);
            const icon = parseField('Icon \\(optional\\)') || 'üìÑ';
            const content = parseField('Content');
            const source = parseField('Source URL \\(optional\\)');
            
            // Generate slug from title
            const slug = title.toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '');
            
            // Determine header image based on category
            const headerImages = {
              'Offensive Security': 'offensive',
              'Learning': 'AITesting',
              'News': 'news'
            };
            const headerImage = headerImages[category] || 'AITesting';
            
            // Create blog post content
            const date = new Date().toISOString().split('T')[0];
            const frontmatter = `---
title: "${title}"
description: "${description}"
pubDate: ${date}
category: "${category}"
icon: "${icon}"
tags: [${tags.map(t => `"${t}"`).join(', ')}]
image: "${headerImage}.png"
draft: false
---
`;
            
            const fullContent = frontmatter + '\n' + content + 
              (source ? `\n\n---\n\n[Original Source](${source})` : '');
            
            // Create the file
            const filePath = `src/content/blog/${slug}.md`;
            
            // Check if file already exists
            try {
              await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: filePath,
              });
              
              // File exists, add comment and close issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚ùå A blog post with this title already exists. Please choose a different title.`
              });
              return;
            } catch (error) {
              // File doesn't exist, proceed
            }
            
            // Get the default branch
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            // Create the blog post file
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: filePath,
              message: `üìù New blog post: ${title}`,
              content: Buffer.from(fullContent).toString('base64'),
              branch: repo.default_branch,
            });
            
            // Add comment to issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `‚úÖ Blog post created successfully!\n\nView it at: https://puffert.github.io/eriksson/blog/${slug}\n\nThe post will be live after the next deployment (usually within 2-3 minutes).`
            });
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });
