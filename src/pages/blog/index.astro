---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
// Filter to only show News and Offensive Security posts (excluding scoping series)
const postsPosts = allPosts.filter((post) => {
  if (post.data.category !== 'News' && post.data.category !== 'Offensive Security') {
    return false;
  }
  // Exclude scoping series posts (they belong in Learning)
  const slug = post.slug.toLowerCase();
  if (slug.includes('scoping') || slug.includes('article-') || slug.includes('scope-series') || 
      slug.includes('model-integration') || slug.includes('multi-turn') || 
      slug.includes('function-calling') || slug.includes('third-party-model') ||
      slug.includes('training-pipeline') || slug.includes('ai-safety-as-security') ||
      slug.includes('continuous-changes') || slug.includes('logging-monitoring') ||
      slug.includes('ai-security-rfps') || slug.includes('ai-incident-response')) {
    return false;
  }
  return true;
});
const sortedPosts = postsPosts.sort((a, b) => 
  b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

const baseUrl = import.meta.env.BASE_URL.endsWith('/') 
  ? import.meta.env.BASE_URL 
  : `${import.meta.env.BASE_URL}/`;
---

<BaseLayout title="Blog Posts">
    <section class="blog-listing">
        <h1 class="section-title">POSTS</h1>
        <p style="text-align: center; color: var(--text-muted); margin-bottom: 40px;">
            News and Offensive Security posts. For learning content, visit the <a href={`${baseUrl}learning`} style="color: var(--accent-color);">Learning</a> page.
        </p>
        
        <div class="posts-grid">
            {sortedPosts.map((post) => (
                <article class="post-card">
                    <div class="post-header">
                        <span class="post-date">
                            {new Intl.DateTimeFormat('en-US', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            }).format(post.data.pubDate)}
                        </span>
                        <span class="post-category">{post.data.category.toUpperCase()}</span>
                    </div>
                    <h2 class="post-title">
                        <a href={`${baseUrl}blog/${post.slug}`} style="color: inherit; text-decoration: none;">
                            {post.data.title}
                        </a>
                    </h2>
                    <p class="post-excerpt">{post.data.description}</p>
                    <a href={`${baseUrl}blog/${post.slug}`} class="post-link">READ MORE â†’</a>
                </article>
            ))}
        </div>

        {sortedPosts.length === 0 && (
            <div style="text-align: center; padding: 60px 20px;">
                <p style="color: var(--text-muted); font-size: 1.2rem;">
                    No posts yet. Check back soon!
                </p>
            </div>
        )}
    </section>
</BaseLayout>
