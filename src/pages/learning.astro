---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
// Include Learning category posts and scoping series posts (even if categorized as Offensive Security)
const learningPosts = allPosts.filter((post) => {
  if (post.data.category === 'Learning') return true;
  // Include scoping series posts
  const slug = post.slug.toLowerCase();
  if (slug.includes('scoping') || slug.includes('article-') || slug.includes('scope-series') || 
      slug.includes('model-integration') || slug.includes('multi-turn') || 
      slug.includes('function-calling') || slug.includes('third-party-model') ||
      slug.includes('training-pipeline') || slug.includes('ai-safety-as-security') ||
      slug.includes('continuous-changes') || slug.includes('logging-monitoring') ||
      slug.includes('ai-security-rfps') || slug.includes('ai-incident-response')) {
    return true;
  }
  return false;
});

// Function to categorize posts into series
function categorizePost(post: typeof learningPosts[0]) {
  const title = post.data.title.toLowerCase();
  const slug = post.slug.toLowerCase();
  
  // Scoping Series
  if (slug.includes('scoping') || slug.includes('article-') || slug.includes('scope-series') || 
      slug.includes('model-integration') || slug.includes('multi-turn') || 
      slug.includes('function-calling') || slug.includes('third-party-model') ||
      slug.includes('training-pipeline') || slug.includes('ai-safety-as-security') ||
      slug.includes('continuous-changes') || slug.includes('logging-monitoring') ||
      slug.includes('ai-security-rfps') || slug.includes('ai-incident-response')) {
    return 'scoping';
  }
  
  // Unsupervised Learning Algorithms
  if (slug.includes('unsupervised') || slug.includes('dbscan') || slug.includes('hdbscan') ||
      slug.includes('gaussian-mixture') || slug.includes('pca') || slug.includes('principal-component') ||
      slug.includes('anomaly-detection') || slug.includes('graph-communities') ||
      slug.includes('k-means')) {
    return 'unsupervised';
  }
  
  // Supervised Learning Algorithms
  if (slug.includes('supervised') || slug.includes('linear-regression') || slug.includes('logistic') ||
      slug.includes('naive-bayes') || slug.includes('k-nearest') || slug.includes('knn') ||
      slug.includes('decision-tree') || slug.includes('descision-tree') ||
      slug.includes('random-forest') || slug.includes('gradient-boosted') ||
      slug.includes('support-vector') || slug.includes('svm')) {
    return 'supervised';
  }
  
  // AI Fundamentals
  if (slug.includes('ai-machine-learning') || slug.includes('machine-learning-and-deep-learning') ||
      title.includes('ai, machine learning') || title.includes('what\'s actually different')) {
    return 'fundamentals';
  }
  
  // Other learning posts (miscellaneous)
  return 'other';
}

// Group posts by series
const seriesGroups = {
  fundamentals: learningPosts.filter(p => categorizePost(p) === 'fundamentals')
    .sort((a, b) => a.data.pubDate.getTime() - b.data.pubDate.getTime()),
  unsupervised: learningPosts.filter(p => categorizePost(p) === 'unsupervised')
    .sort((a, b) => a.data.pubDate.getTime() - b.data.pubDate.getTime()),
  supervised: learningPosts.filter(p => categorizePost(p) === 'supervised')
    .sort((a, b) => a.data.pubDate.getTime() - b.data.pubDate.getTime()),
  scoping: learningPosts.filter(p => categorizePost(p) === 'scoping')
    .sort((a, b) => {
      // Sort scoping series by article number if available
      const aMatch = a.slug.match(/article-(\d+)/);
      const bMatch = b.slug.match(/article-(\d+)/);
      if (aMatch && bMatch) {
        return parseInt(aMatch[1]) - parseInt(bMatch[1]);
      }
      // If no article number, check if it's the overview post (should come first)
      if (a.slug.includes('scoping-what-organizations-get-wrong-serie')) return -1;
      if (b.slug.includes('scoping-what-organizations-get-wrong-serie')) return 1;
      return a.data.pubDate.getTime() - b.data.pubDate.getTime();
    }),
  other: learningPosts.filter(p => categorizePost(p) === 'other')
    .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
};

const baseUrl = import.meta.env.BASE_URL.endsWith('/') 
  ? import.meta.env.BASE_URL 
  : `${import.meta.env.BASE_URL}/`;
---

<BaseLayout title="Learning">
    <section class="hero-section">
        <div class="hero-content">
            <h2 class="hero-title">
                <span class="glitch" data-text="LEARNING HUB">LEARNING HUB</span>
            </h2>
            <p class="hero-subtitle">Resources • Tutorials • Guides</p>
        </div>
    </section>

    {seriesGroups.fundamentals.length > 0 && (
        <section class="posts-section">
            <h2 class="section-title">AI FUNDAMENTALS</h2>
            <div class="posts-grid">
                {seriesGroups.fundamentals.map((post) => (
                    <article class="post-card">
                        <div class="post-header">
                            <span class="post-date">
                                {new Intl.DateTimeFormat('en-US', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                }).format(post.data.pubDate)}
                            </span>
                            <span class="post-category">LEARNING</span>
                        </div>
                        <h3 class="post-title">
                            <a href={`${baseUrl}blog/${post.slug}`} style="color: inherit; text-decoration: none;">
                                {post.data.title}
                            </a>
                        </h3>
                        <p class="post-excerpt">{post.data.description}</p>
                        <a href={`${baseUrl}blog/${post.slug}`} class="post-link">READ MORE →</a>
                    </article>
                ))}
            </div>
        </section>
    )}

    {seriesGroups.unsupervised.length > 0 && (
        <section class="posts-section">
            <h2 class="section-title">UNSUPERVISED LEARNING ALGORITHMS FOR AI SECURITY PROFESSIONALS</h2>
            <div class="posts-grid">
                {seriesGroups.unsupervised.map((post) => (
                    <article class="post-card">
                        <div class="post-header">
                            <span class="post-date">
                                {new Intl.DateTimeFormat('en-US', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                }).format(post.data.pubDate)}
                            </span>
                            <span class="post-category">LEARNING</span>
                        </div>
                        <h3 class="post-title">
                            <a href={`${baseUrl}blog/${post.slug}`} style="color: inherit; text-decoration: none;">
                                {post.data.title}
                            </a>
                        </h3>
                        <p class="post-excerpt">{post.data.description}</p>
                        <a href={`${baseUrl}blog/${post.slug}`} class="post-link">READ MORE →</a>
                    </article>
                ))}
            </div>
        </section>
    )}

    {seriesGroups.supervised.length > 0 && (
        <section class="posts-section">
            <h2 class="section-title">SUPERVISED LEARNING ALGORITHMS FOR AI SECURITY PROFESSIONALS</h2>
            <div class="posts-grid">
                {seriesGroups.supervised.map((post) => (
                    <article class="post-card">
                        <div class="post-header">
                            <span class="post-date">
                                {new Intl.DateTimeFormat('en-US', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                }).format(post.data.pubDate)}
                            </span>
                            <span class="post-category">LEARNING</span>
                        </div>
                        <h3 class="post-title">
                            <a href={`${baseUrl}blog/${post.slug}`} style="color: inherit; text-decoration: none;">
                                {post.data.title}
                            </a>
                        </h3>
                        <p class="post-excerpt">{post.data.description}</p>
                        <a href={`${baseUrl}blog/${post.slug}`} class="post-link">READ MORE →</a>
                    </article>
                ))}
            </div>
        </section>
    )}

    {seriesGroups.scoping.length > 0 && (
        <section class="posts-section">
            <h2 class="section-title">A SCOPING SERIES</h2>
            <div class="posts-grid">
                {seriesGroups.scoping.map((post) => (
                    <article class="post-card">
                        <div class="post-header">
                            <span class="post-date">
                                {new Intl.DateTimeFormat('en-US', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                }).format(post.data.pubDate)}
                            </span>
                            <span class="post-category">LEARNING</span>
                        </div>
                        <h3 class="post-title">
                            <a href={`${baseUrl}blog/${post.slug}`} style="color: inherit; text-decoration: none;">
                                {post.data.title}
                            </a>
                        </h3>
                        <p class="post-excerpt">{post.data.description}</p>
                        <a href={`${baseUrl}blog/${post.slug}`} class="post-link">READ MORE →</a>
                    </article>
                ))}
            </div>
        </section>
    )}

    {seriesGroups.other.length > 0 && (
        <section class="posts-section">
            <h2 class="section-title">OTHER LEARNING RESOURCES</h2>
            <div class="posts-grid">
                {seriesGroups.other.map((post) => (
                    <article class="post-card">
                        <div class="post-header">
                            <span class="post-date">
                                {new Intl.DateTimeFormat('en-US', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                }).format(post.data.pubDate)}
                            </span>
                            <span class="post-category">LEARNING</span>
                        </div>
                        <h3 class="post-title">
                            <a href={`${baseUrl}blog/${post.slug}`} style="color: inherit; text-decoration: none;">
                                {post.data.title}
                            </a>
                        </h3>
                        <p class="post-excerpt">{post.data.description}</p>
                        <a href={`${baseUrl}blog/${post.slug}`} class="post-link">READ MORE →</a>
                    </article>
                ))}
            </div>
        </section>
    )}
</BaseLayout>
